I. DESCRIPTION

py-apnsd is a Python daemon designed to communicate efficiently with the
Apple Push Notification Service (APNS).  It handles both notification and
feedback services.

It is controlled through a ZeroMQ REQ/REP socket with an extremely simple
communication protocol.


II. PROTOCOL

1. Commands

Syntax in BNF:

  command = ( send | "feedback" )
  send = "send" number devicetokens payload
  devicetokens = ( devicetoken_hex | devicetoken_base64 ) [ devicetokens ]

The ``number'' in the ``send'' command is the number of following device
tokens, which may be specified in hexadecimal or base64.  The ``payload''
must not be larger than 256 bytes.  This is a limit enforced by APNS.

2. Replies

For each command, the server replies one message, begining with either
"OK" or "ERROR".

In case of error, an informative message follows the "ERROR" string.

For the ``send'' command, the string following "OK" is irrelevant.
For the ``feedback'' command here is the "OK" replies BNF syntax:

  ok = "OK" number feedbacktokens
  feedbacktokens = timestamp":"devicetoken_base64 [feedbacktokens]

The ``number'' is the number of following feedback tokens.  The ``timestamp''
is a timestamp in the Unix format, as provided by APNS.


III. CERTIFICATES

As time of writing, APNS is signed by Entrust.  You can check this using:
  openssl s_client -connect gateway.sandbox.push.apple.com:2195 

This command will show you the certificate used by APNS.  The output is
quite verbose, but you will see a "Certificate chain" section at the
beginning.  Right now it is:

  Certificate chain
   0 s:/C=US/ST=California/L=Cupertino/O=Apple Inc./OU=iTMS Engineering/CN=gateway.sandbox.push.apple.com
     i:/C=US/O=Entrust, Inc./OU=www.entrust.net/rpa is incorporated by reference/OU=(c) 2009 Entrust, Inc./CN=Entrust Certification Authority - L1C
   1 s:/C=US/O=Entrust, Inc./OU=www.entrust.net/rpa is incorporated by reference/OU=(c) 2009 Entrust, Inc./CN=Entrust Certification Authority - L1C
     i:/O=Entrust.net/OU=www.entrust.net/CPS_2048 incorp. by ref. (limits liab.)/OU=(c) 1999 Entrust.net Limited/CN=Entrust.net Certification Authority (2048)

This last line is the root certificate you need to authenticate APNS'
certificate.  On Debian, you can find it in
  /etc/ssl/certs/Entrust.net_Premium_2048_Secure_Server_CA.pem

In case you need it, just ask "Entrust root certificate" to Google and
once you are on the page on Entrust's website, select "Root Certificates"
and download "entrust_2048_ca.cer".  This is the same file as above.



IV. DESIGN

To be done: Explain:
- Threads
- Persistent queues using SQLite
